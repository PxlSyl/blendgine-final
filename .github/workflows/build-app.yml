name: Build Tauri App

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.os == 'windows-latest' && 'x86_64-pc-windows-msvc' || matrix.os == 'ubuntu-latest' && 'x86_64-unknown-linux-gnu' || 'x86_64-apple-darwin' }}

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          # Install common dependencies
          sudo apt-get install -y libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

          # Additional dependencies for AppImage/GTK packaging
          sudo apt-get install -y libglib2.0-dev librsvg2-bin libgdk-pixbuf2.0-dev shared-mime-info

          # Install WebKit development packages
          sudo apt-get install -y libwebkit2gtk-4.1-dev || \
          sudo apt-get install -y libwebkit2gtk-4.0-dev || \
          sudo apt-get install -y libwebkit2gtk-6.0-dev || \
          sudo apt-get install -y libwebkit2gtk-4.2-dev || \
          echo "⚠️ WebKit dev package not found, using system WebKit"

          # Install patchelf (required by linuxdeploy)
          sudo apt-get install -y patchelf
        shell: bash

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install openssl
        shell: bash

      - name: Verify project structure
        run: |
          echo "=== Verifying project structure ==="
          echo "Current directory: $(pwd)"
          echo "Project structure:"
          ls -la
          echo "Tauri directory:"
          ls -la src-tauri/
          echo "Icons directory:"
          ls -la src-tauri/icons/
          echo "Frontend directory:"
          ls -la frontend/
        shell: bash

      - name: Download and setup FFmpeg
        run: |
          echo "=== Setting up FFmpeg for ${{ matrix.os }} ==="

          # Create bin directory
          mkdir -p src-tauri/bin

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "Downloading FFmpeg for Windows..."
            # Download FFmpeg for Windows
            curl -L -o ffmpeg.zip "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
            unzip -q ffmpeg.zip
            # Find and copy ffmpeg.exe
            find . -name "ffmpeg.exe" -exec cp {} src-tauri/bin/ffmpeg.exe \;
            chmod +x src-tauri/bin/ffmpeg.exe

          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "Downloading FFmpeg for Linux..."
            # Download FFmpeg for Linux
            curl -L -o ffmpeg.tar.xz "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz"
            tar -xf ffmpeg.tar.xz
            # Find and copy ffmpeg binary (Linux compatible)
            find . -name "ffmpeg" -type f -executable -exec cp {} src-tauri/bin/ffmpeg \;
            chmod +x src-tauri/bin/ffmpeg

          else
            echo "Downloading FFmpeg for macOS..."
            # Download FFmpeg for macOS
            curl -L -o ffmpeg.zip "https://evermeet.cx/ffmpeg/getrelease/zip"
            unzip -q ffmpeg.zip
            # Find and copy ffmpeg binary (macOS compatible)
            find . -name "ffmpeg" -type f -exec cp {} src-tauri/bin/ffmpeg \;
            chmod +x src-tauri/bin/ffmpeg
          fi

          echo "FFmpeg setup completed:"
          ls -la src-tauri/bin/
          if [ -f "src-tauri/bin/ffmpeg" ] || [ -f "src-tauri/bin/ffmpeg.exe" ]; then
            echo "✅ FFmpeg binary found and ready"
          else
            echo "❌ FFmpeg binary not found"
            exit 1
          fi
        shell: bash

      - name: Install dependencies
        run: |
          yarn install --frozen-lockfile
        shell: bash

      - name: Ensure icons are present
        run: |
          echo "=== Ensuring icons are present ==="
          if [ ! -f "src-tauri/icons/32x32.png" ]; then
            echo "❌ Icon 32x32.png not found!"
            echo "Creating icons directory if needed..."
            mkdir -p src-tauri/icons
            echo "Current icons:"
            ls -la src-tauri/icons/ || echo "No icons directory"
            exit 1
          else
            echo "✅ All required icons found"
            ls -la src-tauri/icons/
          fi
        shell: bash

      - name: Setup linuxdeploy for AppImage (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "=== Setting up linuxdeploy for AppImage packaging ==="
          mkdir -p tools/linuxdeploy
          cd tools/linuxdeploy
          wget -c "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
          chmod +x linuxdeploy-x86_64.AppImage
          wget -c "https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-x86_64.AppImage"
          chmod +x linuxdeploy-plugin-appimage-x86_64.AppImage
          cd ../..
          echo "✅ linuxdeploy setup completed"
          ls -la tools/linuxdeploy/
        shell: bash

      - name: Build Tauri app (Windows & macOS)
        if: matrix.os != 'ubuntu-latest'
        run: |
          echo "=== Building Tauri app for ${{ matrix.os }} ==="
          yarn build:tauri
        shell: bash
        env:
          VITE_PLATFORM: tauri
          NODE_ENV: production

      - name: Build Tauri app with linuxdeploy (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "=== Building Tauri app for Linux with linuxdeploy ==="
          export PATH="$(pwd)/tools/linuxdeploy:$PATH"
          echo "Exported linuxdeploy to PATH: $PATH"
          # Ensure PKG_CONFIG_PATH includes standard locations
          export PKG_CONFIG_PATH="/usr/lib/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
          echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
          # Verify librsvg2 is correctly detected
          pkg-config --exists librsvg-2.0 && echo "✅ librsvg-2.0 found" || echo "❌ librsvg-2.0 not found"
          yarn build:tauri
        shell: bash
        env:
          VITE_PLATFORM: tauri
          NODE_ENV: production

      - name: Create release directory
        run: |
          mkdir -p release
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp src-tauri/target/release/bundle/msi/*.msi release/blendgine-windows.msi
            cp src-tauri/target/release/bundle/nsis/*.exe release/blendgine-windows.exe
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            cp src-tauri/target/release/bundle/deb/*.deb release/blendgine-linux.deb
            cp src-tauri/target/release/bundle/appimage/*.AppImage release/blendgine-linux.AppImage
          else
            cp src-tauri/target/release/bundle/dmg/*.dmg release/blendgine-macos.dmg
            cp -r src-tauri/target/release/bundle/macos/*.app release/blendgine-macos.app
          fi

          echo "=== Release artifacts created ==="
          ls -la release/
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: blendgine-${{ matrix.os }}
          path: release/

      - name: Create Release
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        run: |
          echo "=== Creating GitHub Release ==="
          echo "Checking release files..."
          ls -la release/

          # Check if any release files exist
          if [ ! "$(ls -A release/)" ]; then
            echo "❌ No release files found, skipping release creation"
            exit 0
          fi

          echo "✅ Release files found, proceeding with release creation"
        shell: bash

      - name: Upload Release
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/blendgine-*
          draft: true
          prerelease: false
          tag_name: v${{ github.run_number }}
          name: Blendgine v${{ github.run_number }}
          body: |
            Automated release of Blendgine application

            ## Downloads
            - **Windows**: MSI installer and portable EXE
            - **Linux**: DEB package and AppImage
            - **macOS**: DMG installer and APP bundle

            ## Changes
            - Native FFmpeg integration
            - WGPU/WGSL optimization
            - Cross-platform compatibility
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Build Debug Information ==="
          echo "OS: ${{ matrix.os }}"
          echo "Node version: $(node --version)"
          echo "Yarn version: $(yarn --version)"
          echo "Rust version: $(rustc --version)"
          echo "Current directory: $(pwd)"
          echo "Project structure:"
          ls -la
          echo "Tauri directory:"
          ls -la src-tauri/
          echo "Icons directory:"
          ls -la src-tauri/icons/
          if [ -d "src-tauri/bin" ]; then
            echo "FFmpeg binary:"
            ls -la src-tauri/bin/
          fi
          if [ -d "src-tauri/target" ]; then
            echo "Target directory contents:"
            ls -la src-tauri/target/
          fi
          if [ -d "release" ]; then
            echo "Release directory contents:"
            ls -la release/
          fi
          echo "Frontend dist:"
          if [ -d "dist" ]; then
            ls -la dist/
          else
            echo "dist directory not found"
          fi
        shell: bash
